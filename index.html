<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tier List Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for color input to ensure it's visible */
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.125rem; /* rounded-sm */
        }
        input[type="color"] {
            -webkit-appearance: none;
            width: 2.5rem; /* w-10 */
            height: 2.5rem; /* h-10 */
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 0.125rem; /* rounded-sm */
        }
       .drag-over-item {
            outline: 3px dashed #60A5FA !important; /* Blue dashed border */
            outline-offset: 2px;
            z-index: 10; /* Ensure it's above other elements */
        }
       .drag-over-tier-area {
            background-color: rgba(79, 70, 229, 0.1) !important; /* Light blueish background for drop zone */
       }
       .tier-label-draggable {
            cursor: grab !important;
       }
       .tier-label-dragging {
            opacity: 0.5;
       }
       .tier-row-drop-target {
            border-top: 3px dashed #4F46E5 !important; /* Indigo dashed border for tier reorder target */
            border-bottom: 3px dashed #4F46E5 !important;
       }


    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // Inline SVG Icons
        const PlusCircleIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>;
        const ListIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;
        const Trash2Icon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6"/><path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const GripVerticalIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 6v12"/><path d="M15 6v12"/></svg>;
        const SunIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.66 6.34l1.41-1.41"/></svg>;
        const MoonIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
        const PencilIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
        const ChevronUpIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>;
        const ChevronDownIcon = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>;

        // Corrected serializeState function
        const serializeState = (tiers, items, tierListTitle) => encodeURIComponent(JSON.stringify({ tiers, items, tierListTitle }));
        
        // Modified deserializeState to return data and error separately
        const deserializeState = (encodedState) => {
          if (!encodedState) return { data: null, error: null };
          try {
            const data = JSON.parse(decodeURIComponent(encodedState));
            if (data && Array.isArray(data.tiers) && Array.isArray(data.items)) {
              const validItems = data.items.map(item => ({ ...item, tierId: data.tiers.some(t => t.id === item.tierId) ? item.tierId : null }));
              const validTiers = data.tiers.map(tier => ({ ...tier, items: Array.isArray(tier.items) ? tier.items.filter(id => validItems.some(i => i.id === id)) : [] }));
              return { data: { tiers: validTiers, items: validItems, tierListTitle: data.tierListTitle }, error: null };
            }
            return { data: null, error: { message: "Invalid URL state format.", type: "warning" } };
          } catch (e) {
            return { data: null, error: { message: `Error parsing URL: ${e.message}`, type: "error" } };
          }
        };

        function App() {
          const [darkMode, setDarkMode] = useState(true);
          const [logs, setLogs] = useState([]);
          const addLog = useCallback((message, type = 'info') => setLogs(prev => [{ message, type, timestamp: new Date().toLocaleTimeString() }, ...prev].slice(0, 100)), []);

          // Deserialize and handle initial data
          const initialDeserializedResult = deserializeState(window.location.hash.substring(1));
          const initialData = initialDeserializedResult.data;

          const [tiers, setTiers] = useState(initialData?.tiers || [
            { id: 's', type: 'name', value: 'S', items: [], color: '#ff7f7f' }, { id: 'a', type: 'name', value: 'A', items: [], color: '#ffbf7f' },
            { id: 'b', type: 'name', value: 'B', items: [], color: '#ffff7f' }, { id: 'c', type: 'name', value: 'C', items: [], color: '#bfff7f' },
            { id: 'd', type: 'name', value: 'D', items: [], color: '#7fbfff' }, { id: 'f', type: 'name', value: 'F', items: [], color: '#bf7fff' },
          ]);
          const [items, setItems] = useState(initialData?.items || []);
          const [tierListTitle, setTierListTitle] = useState(initialData?.tierListTitle || 'My Tier List');
          
          // Log deserialization errors/warnings after initial render
          useEffect(() => {
            if (initialDeserializedResult.error) {
              addLog(initialDeserializedResult.error.message, initialDeserializedResult.error.type);
            }
          }, [initialDeserializedResult.error, addLog]); // addLog is stable

          const [newTierColor, setNewTierColor] = useState('#888888');
          const [editingTierId, setEditingTierId] = useState(null);
          const [editingTierLabel, setEditingTierLabel] = useState('');
          const [editingTierColor, setEditingTierColor] = useState('#888888');
          const [editingTierImageFile, setEditingTierImageFile] = useState(null);
          const [editingTierImageUrl, setEditingTierImageUrl] = useState('');
          const [draggedItemId, setDraggedItemId] = useState(null);
          const [draggedTierId, setDraggedTierId] = useState(null);
          const [showConfiguration, setShowConfiguration] = useState(true);
          const [showLogs, setShowLogs] = useState(false);
          const [draggedOverItemId, setDraggedOverItemId] = useState(null);
          const [draggedOverTierRowId, setDraggedOverTierRowId] = useState(null);
          const [draggedOverTierAreaId, setDraggedOverTierAreaId] = useState(null);

          // Corrected useRef declarations
          const newTierNameRef = useRef(null);
          const newTierImageRef = useRef(null);
          const newItemNameRef = useRef(null);
          const newItemImageFileRef = useRef(null);
          const newItemImageUrlRef = useRef(null);
          const pasteItemsRef = useRef(null);
          const editTierImageFileRef = useRef(null);
          const editTierImageUrlRef = useRef(null);
          
          const standardColors = ['#ff7f7f', '#ffbf7f', '#ffff7f', '#bfff7f', '#7fbfff', '#bf7fff', '#c0c0c0', '#404040'];

          useEffect(() => { document.documentElement.classList.toggle('dark', darkMode); document.body.classList.toggle('bg-black', darkMode); document.body.classList.toggle('bg-gray-100', !darkMode); }, [darkMode]);
          useEffect(() => { const id = setTimeout(() => { window.location.hash = serializeState(tiers, items, tierListTitle); }, 700); return () => clearTimeout(id); }, [tiers, items, tierListTitle]);
          const generateId = useCallback(() => crypto.randomUUID(), []);

          const handleAddTier = () => {
            const name = newTierNameRef.current.value.trim(); const file = newTierImageRef.current.files[0];
            if (!name && !file) { alert("Tier name or image required."); addLog("Add tier: empty.", "warning"); return; }
            let newTier = { id: generateId(), items: [], color: newTierColor };
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => { newTier.type = 'image'; newTier.value = reader.result; setTiers(p => [...p, newTier]); addLog("Added image tier.", "info"); };
              reader.onerror = () => addLog("Error reading tier image.", "error"); reader.readAsDataURL(file);
            } else { newTier.type = name.length === 1 ? 'letter' : 'name'; newTier.value = name; setTiers(p => [...p, newTier]); addLog(`Added text tier: ${name}`, "info"); }
            newTierNameRef.current.value = ''; if (newTierImageRef.current) newTierImageRef.current.value = '';
          };

          const handleAddItem = () => {
            const name = newItemNameRef.current.value.trim(); const url = newItemImageUrlRef.current.value.trim(); const file = newItemImageFileRef.current.files[0];
            if (!name && !url && !file) { alert("Item details required."); addLog("Add item: empty.", "warning"); return; }
            let newItem = { id: generateId(), tierId: null };
            if (url) {
              if (!url.startsWith('http')) { alert("Invalid URL."); addLog("Invalid item URL.", "error"); return; }
              newItem.type = 'image'; newItem.value = url; setItems(p => [...p, newItem]); addLog("Added URL item.", "info");
            } else if (file) {
              const reader = new FileReader();
              reader.onloadend = () => { newItem.type = 'image'; newItem.value = reader.result; setItems(p => [...p, newItem]); addLog("Added file item.", "info"); };
              reader.onerror = () => addLog("Error item image.", "error"); reader.readAsDataURL(file);
            } else { newItem.type = 'name'; newItem.value = name; setItems(p => [...p, newItem]); addLog(`Added text item: ${name}`, "info"); }
            newItemNameRef.current.value = ''; if (newItemImageUrlRef.current) newItemImageUrlRef.current.value = ''; if (newItemImageFileRef.current) newItemImageFileRef.current.value = '';
          };

          const handlePasteItems = () => {
            const text = pasteItemsRef.current.value.trim(); if (!text) { alert("Paste area empty."); return; }
            const newItems = text.split('\n').map(l => ({ id: generateId(), type: 'name', value: l.trim(), tierId: null })).filter(i => i.value);
            setItems(p => [...p, ...newItems]); addLog(`Pasted ${newItems.length} items.`, "info"); pasteItemsRef.current.value = '';
          };

          const cleanupDragStates = () => { setDraggedItemId(null); setDraggedTierId(null); setDraggedOverItemId(null); setDraggedOverTierRowId(null); setDraggedOverTierAreaId(null); addLog("Drag End: States cleaned.", "debug"); };
          
          const handleItemDragStart = (e, itemId) => { addLog(`ITEM Drag Start: ${itemId}`, "action"); setDraggedItemId(itemId); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', itemId); };
          
          const handleItemDragEnter = (e, targetItemId, targetItemTierId) => {
            e.preventDefault(); e.stopPropagation();
            if (draggedItemId && draggedItemId !== targetItemId) {
              addLog(`>>> ITEM onDragEnter: Target ${targetItemId} in tier ${targetItemTierId}. Dragged: ${draggedItemId}`, "event");
              setDraggedOverItemId(targetItemId);
              setDraggedOverTierAreaId(targetItemTierId);
            }
          };

          const handleItemDragOver = (e, targetItemId, targetItemTierId) => {
            e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect = 'move';
            if (draggedItemId && draggedItemId !== targetItemId) {
              addLog(`>>> ENTERED Item Drag Over ITEM: Over ${targetItemId}`, "event");
              setDraggedOverItemId(targetItemId);
              setDraggedOverTierAreaId(targetItemTierId);
            }
          };

          const handleItemDragLeave = (e, itemId) => {
            e.stopPropagation();
            if (!e.currentTarget.contains(e.relatedTarget)) {
                addLog(`>>> ITEM onDragLeave: ${itemId}`, "event");
                setDraggedOverItemId(null); 
            }
          };

          const handleTierAreaDragEnter = (e, tierIdContext) => {
            e.preventDefault(); e.stopPropagation();
            if (draggedItemId) {
                addLog(`>>> TIER AREA onDragEnter: Tier ${tierIdContext}. DraggedItem: ${draggedItemId}`, "event");
                setDraggedOverTierAreaId(tierIdContext);
                setDraggedOverItemId(null);
            }
          };
          
          const handleTierAreaDragOver = (e, tierIdContext) => {
            e.preventDefault(); e.stopPropagation();
            if (draggedItemId) {
                e.dataTransfer.dropEffect = 'move';
                addLog(`>>> ENTERED TIER AREA Drag Over: Tier ${tierIdContext}. DraggedItem: ${draggedItemId}`, "event");
                setDraggedOverTierAreaId(tierIdContext);
                setDraggedOverItemId(null);
            }
          };

          const handleTierAreaDragLeave = (e, tierIdContext) => {
            e.stopPropagation();
            if (!e.currentTarget.contains(e.relatedTarget) && draggedItemId) {
                 addLog(`>>> TIER AREA onDragLeave: Tier ${tierIdContext}. DraggedItem: ${draggedItemId}`, "event");
                 setDraggedOverTierAreaId(null);
            }
          };

          const handleTierLabelDragStart = (e, tierId) => {
            addLog(`TIER LABEL Drag Start: ${tierId}`, "action");
            setDraggedTierId(tierId);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', tierId);
          };

          const handleTierRowDragOver = (e, targetTierId) => {
            e.preventDefault(); 
            if (draggedTierId && draggedTierId !== targetTierId) {
              e.dataTransfer.dropEffect = 'move';
              setDraggedOverTierRowId(targetTierId);
              addLog(`>>> TIER ROW onDragOver (for tier reorder): Target ${targetTierId}. DraggedTier: ${draggedTierId}`, "event");
            } else if (draggedItemId) {
              e.dataTransfer.dropEffect = 'move'; 
              addLog(`>>> TIER ROW onDragOver (item passing): Target ${targetTierId}. DraggedItem: ${draggedItemId}`, "debug");
            }
          };
           const handleTierRowDragLeave = (e, tierId) => {
            if (!e.currentTarget.contains(e.relatedTarget) && draggedTierId) {
                addLog(`>>> TIER ROW onDragLeave: ${tierId}`, "event");
                setDraggedOverTierRowId(null);
            }
          };

          const handleItemDrop = (e, targetTierId, beforeItemId = null) => {
            e.preventDefault(); e.stopPropagation();
            const droppedItemId = draggedItemId || e.dataTransfer.getData('text/plain');
            if (!droppedItemId || draggedTierId) { addLog("Item drop cancelled: Not item drag.", "warning"); cleanupDragStates(); return; }
            const itemToMove = items.find(i => i.id === droppedItemId);
            if (!itemToMove) { addLog("Item drop: Item not found.", "error"); cleanupDragStates(); return; }
            
            addLog(`ITEM DROP: Item ${droppedItemId} to tier ${targetTierId}, before ${beforeItemId || 'end'}. Source: ${itemToMove.tierId}`, "action");

            setItems(prev => prev.map(i => i.id === droppedItemId ? { ...i, tierId: targetTierId } : i));
            setTiers(prev => {
              let newTiers = prev.map(t => t.id === itemToMove.tierId ? { ...t, items: t.items.filter(id => id !== droppedItemId) } : t);
              if (targetTierId) {
                newTiers = newTiers.map(t => {
                  if (t.id === targetTierId) {
                    let newItemsInTier = t.items.filter(id => id !== droppedItemId);
                    const idx = beforeItemId ? newItemsInTier.indexOf(beforeItemId) : -1;
                    if (idx !== -1) newItemsInTier.splice(idx, 0, droppedItemId);
                    else newItemsInTier.push(droppedItemId);
                    return { ...t, items: newItemsInTier };
                  } return t;
                });
              } return newTiers;
            });
            cleanupDragStates();
          };

          const handleTierDrop = (e, targetTierId) => {
            e.preventDefault(); 
            const dTierId = draggedTierId || e.dataTransfer.getData('text/plain');
            if (!dTierId || dTierId === targetTierId || draggedItemId) { addLog("Tier drop cancelled.", "warning"); cleanupDragStates(); return; }
            addLog(`TIER DROP: Tier ${dTierId} onto ${targetTierId}`, "action");
            setTiers(prev => {
              const dTier = prev.find(t => t.id === dTierId); if (!dTier) return prev;
              const remaining = prev.filter(t => t.id !== dTierId);
              const targetIdx = remaining.findIndex(t => t.id === targetTierId);
              if (targetIdx !== -1) remaining.splice(targetIdx, 0, dTier); else remaining.push(dTier);
              return remaining;
            });
            cleanupDragStates();
          };
          
          const handleDeleteItem = (id) => { setItems(p => p.filter(i => i.id !== id)); setTiers(p => p.map(t => ({ ...t, items: t.items.filter(itemId => itemId !== id) }))); addLog(`Deleted item ${id}`, "action"); };
          const handleDeleteTier = (id) => { const tierDel = tiers.find(t=>t.id===id); if(tierDel) setItems(p=>p.map(i=>tierDel.items.includes(i.id)?{...i, tierId:null}:i)); setTiers(p => p.filter(t => t.id !== id)); if(editingTierId===id) cancelEditingTier(); addLog(`Deleted tier ${id}`, "action"); };
          const startEditingTier = (tier) => { setEditingTierId(tier.id); setEditingTierLabel(tier.type !== 'image' ? tier.value : ''); setEditingTierColor(tier.color); setEditingTierImageUrl(tier.type === 'image' && tier.value.startsWith('http') ? tier.value : ''); setEditingTierImageFile(null); if(editTierImageFileRef.current) editTierImageFileRef.current.value=''; if(editTierImageUrlRef.current) editTierImageUrlRef.current.value = (tier.type === 'image' && tier.value.startsWith('http') ? tier.value : ''); setShowConfiguration(true); addLog(`Editing tier ${tier.id}`, "info"); };
          
          const handleSaveEditedTier = () => {
            if (!editingTierId) return;
            let updatedValue = editingTierLabel.trim(); let updatedType = updatedValue.length === 1 ? 'letter' : 'name';
            const save = (val, type, col) => { setTiers(p => p.map(t => t.id === editingTierId ? { ...t, value: val, type: type, color: col } : t)); addLog(`Saved tier ${editingTierId}`, "action"); cancelEditingTier();};
            if (editTierImageUrlRef.current.value.trim()) { // Use ref here
              const url = editTierImageUrlRef.current.value.trim();
              if (!url.startsWith('http')) { alert("Invalid URL."); return; }
              save(url, 'image', editingTierColor);
            } else if (editingTierImageFile) {
              const reader = new FileReader();
              reader.onloadend = () => save(reader.result, 'image', editingTierColor);
              reader.readAsDataURL(editingTierImageFile);
            } else if (updatedValue) {
              save(updatedValue, updatedType, editingTierColor);
            } else { 
                const currentTier = tiers.find(t => t.id === editingTierId);
                if (currentTier && currentTier.type === 'image') save(currentTier.value, 'image', editingTierColor);
                else alert("Label cannot be empty for text tiers.");
            }
          };
          const cancelEditingTier = () => { setEditingTierId(null); setEditingTierLabel(''); setEditingTierColor('#888888'); setEditingTierImageUrl(''); setEditingTierImageFile(null); if(editTierImageFileRef.current) editTierImageFileRef.current.value=''; if(editTierImageUrlRef.current) editTierImageUrlRef.current.value=''; addLog("Edit tier cancelled.", "info"); };
          const unassignedItems = items.filter(item => item.tierId === null);
          const handleHexColorChange = (e, isEditing) => { const hex = e.target.value; if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(hex)) { if (isEditing) setEditingTierColor(hex); else setNewTierColor(hex); }};
          const copyLogsToClipboard = () => { navigator.clipboard.writeText(logs.map(l => `[${l.timestamp}] [${l.type.toUpperCase()}] ${l.message}`).join('\n')).then(()=>alert("Logs copied!")).catch(()=>alert("Copy failed.")); addLog("Logs copied.", "info");};
          const selectAllLogs = () => { const area = document.querySelector('.log-display-area'); if(area){ const r=document.createRange();r.selectNodeContents(area);const s=window.getSelection();s.removeAllRanges();s.addRange(r);alert("Logs selected!");} addLog("Logs selected.", "info");};

          const theme = { bg: darkMode ? 'bg-black' : 'bg-gray-100', text: darkMode ? 'text-gray-100' : 'text-gray-900', containerBg: darkMode ? 'bg-gray-900' : 'bg-white', inputBg: darkMode ? 'bg-gray-700' : 'bg-gray-50', inputText: darkMode ? 'text-gray-100' : 'text-gray-900', placeholderText: darkMode ? 'placeholder-gray-400' : 'placeholder-gray-500', borderColor: darkMode ? 'border-gray-700' : 'border-gray-300', buttonPrimaryBg: darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600', buttonSecondaryBg: darkMode ? 'bg-gray-600 hover:bg-gray-700' : 'bg-gray-500 hover:bg-gray-600', buttonText: 'text-white', sectionBg: darkMode ? 'bg-gray-800' : 'bg-gray-50', };

          const renderItem = (item) => ( // Added item parameter
            <div
              key={item.id}
              draggable="true"
              onDragStart={(e) => handleItemDragStart(e, item.id)}
              onDragEnter={(e) => handleItemDragEnter(e, item.id, item.tierId)}
              onDragOver={(e) => handleItemDragOver(e, item.id, item.tierId)}
              onDragLeave={(e) => handleItemDragLeave(e, item.id)}
              onDrop={(e) => { addLog(`ITEM onDrop: Dragged ${draggedItemId} onto item ${item.id} (becomes beforeItemId) in tier ${item.tierId}`, "event"); handleItemDrop(e, item.tierId, item.id); }}
              onDragEnd={cleanupDragStates}
              data-item-id={item.id}
              className={`relative flex items-center justify-center w-20 h-20 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-sm shadow-sm cursor-grab active:cursor-grabbing hover:shadow-md transition-all duration-200 overflow-hidden group z-10 
                ${draggedItemId === item.id ? 'opacity-30 ring-2 ring-indigo-500' : ''}
                ${draggedOverItemId === item.id && draggedItemId !== item.id ? 'drag-over-item' : ''}`}
            >
              {item.type === 'image' ? (
                <img src={item.value} alt={item.value || "Item"} className="w-full h-full object-cover pointer-events-none" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/64x64/FF0000/FFFFFF?text=Error`; e.target.alt = "Image failed"; addLog(`Failed image: ${item.value}`, "error"); }} />
              ) : (
                <span className="text-sm font-medium text-gray-800 dark:text-gray-200 text-center p-1 break-words pointer-events-none">{item.value}</span>
              )}
              <button onClick={() => handleDeleteItem(item.id)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 z-20"> <Trash2Icon size={14} /> </button>
            </div>
          );

          return (
            <div className={`min-h-screen font-sans p-0 transition-colors duration-300 ${theme.bg} ${theme.text}`}>
              <div className="max-w-7xl mx-auto">
                <div className={`flex justify-between items-center p-4 ${theme.containerBg}`}>
                  <input type="text" value={tierListTitle} onChange={(e) => setTierListTitle(e.target.value)} className={`text-3xl sm:text-4xl font-extrabold bg-transparent border-none focus:outline-none focus:ring-0 text-left w-full mr-4 ${theme.text}`} />
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-full ${darkMode ? 'bg-gray-700 text-gray-200 hover:bg-gray-600' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'} shadow-md`}> {darkMode ? <SunIcon size={24} /> : <MoonIcon size={24} />} </button>
                </div>

                <div className="flex flex-col gap-0">
                  <div className={`${theme.containerBg} w-full`}>
                    {tiers.map((tier, index) => (
                      <div 
                        key={tier.id}
                        data-tier-id={tier.id}
                        onDragOver={(e) => handleTierRowDragOver(e, tier.id)}
                        onDragLeave={(e) => handleTierRowDragLeave(e, tier.id)}
                        onDrop={(e) => handleTierDrop(e, tier.id)}
                        className={`flex items-stretch min-h-[100px] transition-all duration-200
                          ${draggedOverTierRowId === tier.id && draggedTierId && draggedTierId !== tier.id ? 'tier-row-drop-target' : ''}
                          ${index > 0 ? theme.borderColor : ''} ${index > 0 ? 'border-t' : ''}`}
                      >
                        <div 
                          draggable="true"
                          onDragStart={(e) => handleTierLabelDragStart(e, tier.id)}
                          onDragEnd={cleanupDragStates} // Moved DragEnd for tier label here
                          className={`relative flex-shrink-0 w-24 sm:w-32 p-3 flex items-center justify-center text-center font-bold text-lg text-black group tier-label-draggable ${draggedTierId === tier.id ? 'tier-label-dragging' : ''}`}
                          style={{ backgroundColor: tier.color }}
                        >
                          {tier.type === 'image' ? <img src={tier.value} alt="Tier" className="w-20 h-20 object-contain pointer-events-none" /> : <span className="pointer-events-none">{tier.value}</span>}
                          <button onClick={() => handleDeleteTier(tier.id)} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 z-10"> <Trash2Icon size={14} /> </button>
                          <button onClick={() => startEditingTier(tier)} className="absolute top-1 left-1 bg-gray-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 z-10"> <PencilIcon size={14} /> </button>
                        </div>
                        
                        <div 
                          onDragEnter={(e) => handleTierAreaDragEnter(e, tier.id)}
                          onDragOver={(e) => handleTierAreaDragOver(e, tier.id)}
                          onDragLeave={(e) => handleTierAreaDragLeave(e, tier.id)}
                          onDrop={(e) => { addLog(`TIER AREA onDrop: Tier ${tier.id}, BeforeItem=null`, "event"); handleItemDrop(e, tier.id, null);}}
                          className={`flex-grow p-2 flex flex-wrap gap-1 items-start justify-start min-h-[100px] ${theme.containerBg} 
                            ${draggedOverTierAreaId === tier.id && draggedItemId && !draggedOverItemId ? 'drag-over-tier-area' : ''}`}
                        >
                          {tier.items.map(itemId => { const item = items.find(i => i.id === itemId); return item ? renderItem(item) : null; })}
                          {tier.items.length === 0 && <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-sm italic p-4 pointer-events-none`}>Drag items here...</p>}
                        </div>
                      </div>
                    ))}
                  </div>

                  <div 
                    onDragEnter={(e) => handleTierAreaDragEnter(e, null)}
                    onDragOver={(e) => handleTierAreaDragOver(e, null)}
                    onDragLeave={(e) => handleTierAreaDragLeave(e, null)}
                    onDrop={(e) => { addLog(`POOL AREA onDrop: BeforeItem=null`, "event"); handleItemDrop(e, null, null);}}
                    className={`p-4 min-h-[150px] flex flex-col w-full ${theme.containerBg} ${theme.borderColor} border-t
                      ${draggedOverTierAreaId === null && draggedItemId ? 'drag-over-tier-area' : ''}`}
                  >
                    <h2 className={`text-xl font-semibold ${theme.text} mb-3 flex items-center justify-center gap-2`}> <GripVerticalIcon size={20} /> Item Pool </h2>
                    <div className="flex flex-wrap gap-1 justify-center sm:justify-start flex-grow min-h-[100px]">
                      {unassignedItems.length === 0 ? <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm text-center w-full`}>Add or drag items here.</p> : unassignedItems.map(item => renderItem(item))}
                    </div>
                  </div>
                </div>

                <div className={`${theme.containerBg} p-4 w-full ${theme.borderColor} border-t`}>
                  <h2 className={`text-2xl font-bold ${theme.text} mb-4 text-center flex items-center justify-center gap-2`}>
                    Configuration
                    <button onClick={() => setShowConfiguration(!showConfiguration)} className={`p-1 rounded-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-300 hover:bg-gray-400'}`}> {showConfiguration ? <ChevronUpIcon size={20} /> : <ChevronDownIcon size={20} />} </button>
                  </h2>
                  {showConfiguration && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {editingTierId ? (
                        <div className={`${theme.sectionBg} p-3 rounded-sm border ${theme.borderColor}`}>
                          <h3 className={`text-xl font-semibold ${darkMode ? 'text-indigo-300':'text-indigo-600'} mb-2 flex items-center gap-2`}> <PencilIcon size={20}/> Edit Tier</h3>
                          <input type="text" value={editingTierLabel} onChange={e=>setEditingTierLabel(e.target.value)} placeholder="Label" className={`w-full p-2 mb-2 border ${theme.borderColor} rounded-sm ${theme.inputBg} ${theme.inputText}`}/>
                          <input type="text" ref={editTierImageUrlRef} defaultValue={editingTierImageUrl} onChange={e=>setEditingTierImageUrl(e.target.value)} placeholder="Image URL" className={`w-full p-2 mb-2 border ${theme.borderColor} rounded-sm ${theme.inputBg} ${theme.inputText}`}/>
                          <input type="file" ref={editTierImageFileRef} onChange={e=>setEditingTierImageFile(e.target.files[0])} accept="image/*" className={`w-full mb-2 text-sm ${theme.inputText} file:mr-2 file:py-1 file:px-3 file:rounded-sm file:border-0 ${darkMode ? 'file:bg-indigo-700 file:text-indigo-100':'file:bg-indigo-200 file:text-indigo-700'}`}/>
                          <div className="flex items-center gap-2 mb-2"> {standardColors.map(c=><button key={c} onClick={()=>setEditingTierColor(c)} className={`w-7 h-7 rounded-full border-2 ${editingTierColor===c?(darkMode?'border-white':'border-black'):'border-transparent'}`} style={{backgroundColor:c}}/>)} </div>
                          <div className="flex items-center gap-2 mb-3">
                            <input type="color" value={editingTierColor} onChange={e=>setEditingTierColor(e.target.value)} className={`w-9 h-9 rounded-sm ${darkMode?'border-gray-600':'border-gray-400'} border`}/>
                            <input type="text" value={editingTierColor} onChange={e=>handleHexColorChange(e,true)} placeholder="#hex" className={`p-2 w-28 border ${theme.borderColor} rounded-sm ${theme.inputBg} ${theme.inputText}`}/>
                          </div>
                          <div className="flex gap-2"><button onClick={handleSaveEditedTier} className={`flex-1 py-2 ${darkMode?'bg-indigo-600 hover:bg-indigo-700':'bg-indigo-500 hover:bg-indigo-600'} ${theme.buttonText} rounded-sm`}>Save</button> <button onClick={cancelEditingTier} className={`flex-1 py-2 ${theme.buttonSecondaryBg} ${theme.buttonText} rounded-sm`}>Cancel</button></div>
                        </div>
                      ) : (
                        <div className={`${theme.sectionBg} p-3 rounded-sm border ${theme.borderColor}`}>
                          <h3 className={`text-xl font-semibold ${darkMode ? 'text-blue-300':'text-blue-600'} mb-2 flex items-center gap-2`}> <PlusCircleIcon size={20}/> Create Tier</h3>
                          <input type="text" ref={newTierNameRef} placeholder="Label" className={`w-full p-2 mb-2 border ${theme.borderColor} rounded-sm ${theme.inputBg} ${theme.inputText}`}/>
                          <input type="file" ref={newTierImageRef} accept="image/*" className={`w-full mb-2 text-sm ${theme.inputText} file:mr-2 file:py-1 file:px-3 file:rounded-sm file:border-0 ${darkMode ? 'file:bg-blue-800 file:text-blue-100':'file:bg-blue-200 file:text-blue-700'}`}/>
                          <div className="flex items-center gap-2 mb-2"> {standardColors.map(c=><button key={c} onClick={()=>setNewTierColor(c)} className={`w-7 h-7 rounded-full border-2 ${newTierColor===c?(darkMode?'border-white':'border-black'):'border-transparent'}`} style={{backgroundColor:c}}/>)} </div>
                          <div className="flex items-center gap-2 mb-3">
                            <input type="color" value={newTierColor} onChange={e=>setNewTierColor(e.target.value)} className={`w-9 h-9 rounded-sm ${darkMode?'border-gray-600':'border-gray-400'} border`}/>
                            <input type="text" value={newTierColor} onChange={e=>handleHexColorChange(e,false)} placeholder="#hex" className={`p-2 w-28 border ${theme.borderColor} rounded-sm ${theme.inputBg} ${theme.inputText}`}/>
                          </div>
                          <button onClick={handleAddTier} className={`w-full py-2 ${theme.buttonPrimaryBg} ${theme.buttonText} rounded-sm`}>Add Tier</button>
                        </div>
                      )}
                      <div className={`${theme.sectionBg} p-3 rounded-sm border ${theme.borderColor}`}>
                        <h3 className={`text-xl font-semibold ${darkMode ? 'text-green-300':'text-green-600'} mb-2 flex items-center gap-2`}> <PlusCircleIcon size={20}/> Add Item</h3>
                        <input type="text" ref={newItemNameRef} placeholder="Name" className={`w-full p-2 mb-2 border ${theme.borderColor} rounded-sm ${theme.inputBg} ${theme.inputText}`}/>
                        <input type="text" ref={newItemImageUrlRef} placeholder="Image URL" className={`w-full p-2 mb-2 border ${theme.borderColor} rounded-sm ${theme.inputBg} ${theme.inputText}`}/>
                        <input type="file" ref={newItemImageFileRef} accept="image/*" className={`w-full mb-3 text-sm ${theme.inputText} file:mr-2 file:py-1 file:px-3 file:rounded-sm file:border-0 ${darkMode ? 'file:bg-green-800 file:text-green-100':'file:bg-green-200 file:text-green-700'}`}/>
                        <button onClick={handleAddItem} className={`w-full py-2 ${darkMode?'bg-green-600 hover:bg-green-700':'bg-green-500 hover:bg-green-600'} ${theme.buttonText} rounded-sm`}>Add Item</button>
                      </div>
                      <div className={`${theme.sectionBg} p-3 rounded-sm border ${theme.borderColor}`}>
                        <h3 className={`text-xl font-semibold ${darkMode ? 'text-yellow-300':'text-yellow-600'} mb-2 flex items-center gap-2`}> <ListIcon size={20}/> Paste Items</h3>
                        <textarea ref={pasteItemsRef} rows="5" placeholder="One per line" className={`w-full p-2 mb-3 border ${theme.borderColor} rounded-sm resize-y ${theme.inputBg} ${theme.inputText}`}></textarea>
                        <button onClick={handlePasteItems} className={`w-full py-2 ${darkMode?'bg-yellow-600 hover:bg-yellow-700':'bg-yellow-500 hover:bg-yellow-600'} ${theme.buttonText} rounded-sm`}>Add Pasted</button>
                      </div>
                    </div>
                  )}
                </div>

                <div className={`${theme.containerBg} p-4 w-full ${theme.borderColor} border-t mt-4`}>
                  <h2 className={`text-2xl font-bold ${theme.text} mb-4 text-center flex items-center justify-center gap-2`}>
                    Logs <button onClick={()=>setShowLogs(!showLogs)} className={`p-1 rounded-full ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-300 hover:bg-gray-400'}`}>{showLogs?<ChevronUpIcon size={20}/>:<ChevronDownIcon size={20}/>}</button>
                  </h2>
                  {showLogs && (<>
                    <div className="flex gap-2 mb-3"> <button onClick={copyLogsToClipboard} className={`flex-1 py-1.5 px-3 rounded-sm ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-300 hover:bg-gray-400'}`}>Copy</button> <button onClick={selectAllLogs} className={`flex-1 py-1.5 px-3 rounded-sm ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-300 hover:bg-gray-400'}`}>Select All</button> </div>
                    <div className={`log-display-area flex flex-col gap-1 ${theme.sectionBg} p-3 rounded-sm border ${theme.borderColor} max-h-60 overflow-y-auto text-left`}>
                      {logs.length === 0 ? <p className={`${darkMode?'text-gray-400':'text-gray-600'} text-sm`}>No logs.</p> : logs.map((l,i)=>(
                        <p key={i} className={`text-xs font-mono ${l.type==='error'?(darkMode?'text-red-400':'text-red-600'):l.type==='warning'?(darkMode?'text-yellow-400':'text-yellow-600'):l.type==='action'?(darkMode?'text-blue-300':'text-blue-600'):l.type==='event'?(darkMode?'text-purple-300':'text-purple-600'):(darkMode?'text-gray-300':'text-gray-700')}`}>
                          <span className={`${darkMode?'text-gray-500':'text-gray-400'}`}>{l.timestamp}</span> <span className={`font-bold ${l.type==='error'?(darkMode?'text-red-500':'text-red-700'):l.type==='warning'?(darkMode?'text-yellow-500':'text-yellow-700'):l.type==='action'?(darkMode?'text-blue-400':'text-blue-700'):l.type==='event'?(darkMode?'text-purple-400':'text-purple-700'):(darkMode?'text-gray-400':'text-gray-500')}`}>[{l.type.toUpperCase()}]</span> {l.message}
                        </p>
                      ))}
                    </div></>
                  )}
                </div>
              </div>
            </div>
          );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
